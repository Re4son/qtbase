
Parent: 732c9948 (work around MSVC level 4 warning)
Author: Albert Astals Cid <albert.astals@canonical.com>
AuthorDate: 2015-02-17 09:53:27 +0100
Commit: Friedemann Kleint <Friedemann.Kleint@theqtcompany.com>
CommitDate: 2015-02-17 13:47:16 +0000

Make sure there's a scene before using it

Fixes crash hovering links in quassel

Task-number: QTBUG-44509
Change-Id: I77d8d9118ad185ed70a46e91445e2960200e562b
Reviewed-by: Michael Br√ºning <michael.bruning@theqtcompany.com>
Reviewed-by: Frederik Gladhorn <frederik.gladhorn@theqtcompany.com>
Reviewed-by: Marc Mutz <marc.mutz@kdab.com>

diff a/src/widgets/kernel/qwidget.cpp b/src/widgets/kernel/qwidget.cpp b/src/widgets/kernel/qwidget.cpp b/src/widgets/kernel/qwidget.cpp
Index: qtbase-opensource-src-5.4.0+dfsg/tests/auto/widgets/graphicsview/qgraphicsproxywidget/tst_qgraphicsproxywidget.cpp
===================================================================
--- qtbase-opensource-src-5.4.0+dfsg.orig/tests/auto/widgets/graphicsview/qgraphicsproxywidget/tst_qgraphicsproxywidget.cpp	2015-02-22 02:36:23.084912199 -0500
+++ qtbase-opensource-src-5.4.0+dfsg/tests/auto/widgets/graphicsview/qgraphicsproxywidget/tst_qgraphicsproxywidget.cpp	2015-02-22 02:36:23.084912199 -0500
@@ -175,6 +175,7 @@
     void windowFrameMargins();
     void QTBUG_6986_sendMouseEventToAlienWidget();
     void mapToGlobal();
+    void mapToGlobalWithoutScene();
 };
 
 // Subclass that exposes the protected functions.
@@ -3687,5 +3688,15 @@
                         .arg(embeddedCenterGlobal.x()).arg(embeddedCenterGlobal.y())));
 }
 
+void tst_QGraphicsProxyWidget::mapToGlobalWithoutScene() // QTBUG-44509
+{
+ QGraphicsProxyWidget proxyWidget;
+ QWidget *embeddedWidget = new QWidget;
+ proxyWidget.setWidget(embeddedWidget);
+const QPoint localPos(0, 0);
+ const QPoint globalPos = embeddedWidget->mapToGlobal(localPos);
+ QCOMPARE(embeddedWidget->mapFromGlobal(globalPos), localPos);
+}
+
 QTEST_MAIN(tst_QGraphicsProxyWidget)
 #include "tst_qgraphicsproxywidget.moc"
Index: qtbase-opensource-src-5.4.0+dfsg/src/widgets/kernel/qwidget.cpp
===================================================================
--- qtbase-opensource-src-5.4.0+dfsg.orig/src/widgets/kernel/qwidget.cpp	2015-02-22 02:36:23.084912199 -0500
+++ qtbase-opensource-src-5.4.0+dfsg/src/widgets/kernel/qwidget.cpp	2015-02-22 02:38:15.200916922 -0500
@@ -12255,7 +12255,7 @@
 {
 #ifndef QT_NO_GRAPHICSVIEW
     Q_D(const QWidget);
-    if (d->extra && d->extra->proxyWidget) {
+    if (d->extra && d->extra->proxyWidget && d->extra->proxyWidget->scene()) {
         const QList <QGraphicsView *> views = d->extra->proxyWidget->scene()->views();
         if (!views.isEmpty()) {
             const QPointF scenePos = d->extra->proxyWidget->mapToScene(pos);
@@ -12290,7 +12290,7 @@
 {
 #ifndef QT_NO_GRAPHICSVIEW
     Q_D(const QWidget);
-    if (d->extra && d->extra->proxyWidget) {
+    if (d->extra && d->extra->proxyWidget && d->extra->proxyWidget->scene()) {
         const QList <QGraphicsView *> views = d->extra->proxyWidget->scene()->views();
         if (!views.isEmpty()) {
             const QPoint viewPortPos = views.first()->viewport()->mapFromGlobal(pos);
